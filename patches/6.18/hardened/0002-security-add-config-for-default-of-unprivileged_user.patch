From 692b9db5edd45da687eeb51b498eeca6e6abc1ce Mon Sep 17 00:00:00 2001
From: "Jan Alexander Steffens (heftig)" <heftig@archlinux.org>
Date: Thu, 22 May 2025 07:32:13 +0200
Subject: [PATCH 7/194] security: add config for default of
 unprivileged_userns_clone

---
 init/Kconfig  | 16 ++++++++++++++++
 kernel/fork.c |  4 ++++
 2 files changed, 20 insertions(+)

diff --git a/init/Kconfig b/init/Kconfig
index 209b5dae703b..958fe6d79d6a 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -1389,10 +1389,26 @@ config USER_NS
 	  user-space use the memory control groups to limit the amount
 	  of memory a memory unprivileged users can use.
 
 	  If unsure, say N.
 
+config USER_NS_UNPRIVILEGED
+	bool "Allow unprivileged users to create namespaces"
+	default y
+	depends on USER_NS
+	help
+	  When disabled, unprivileged users will not be able to create
+	  new namespaces. Allowing users to create their own namespaces
+	  has been part of several recent local privilege escalation
+	  exploits, so if you need user namespaces but are
+	  paranoid^Wsecurity-conscious you want to disable this.
+
+	  This setting can be overridden at runtime via the
+	  kernel.unprivileged_userns_clone sysctl.
+
+	  If unsure, say Y.
+
 config PID_NS
 	bool "PID Namespaces"
 	default y
 	help
 	  Support process id namespaces.  This allows having multiple
diff --git a/kernel/fork.c b/kernel/fork.c
index 07349223afff..ef65f7e42356 100644
--- a/kernel/fork.c
+++ b/kernel/fork.c
@@ -122,11 +122,15 @@
 #include <trace/events/task.h>
 
 #include <kunit/visibility.h>
 
 #ifdef CONFIG_USER_NS
+# ifdef CONFIG_USER_NS_UNPRIVILEGED
 static int unprivileged_userns_clone = 1;
+# else
+static int unprivileged_userns_clone = 0;
+# endif
 #else
 #define unprivileged_userns_clone 1
 #endif
 
 /*
-- 
2.52.0

