From efdfbf10f2cba4660e54566b0116c72f2682a829 Mon Sep 17 00:00:00 2001
From: Daniel Micay <danielmicay@gmail.com>
Date: Sun, 25 Feb 2018 03:26:45 -0500
Subject: [PATCH 130/162] hard-wire legacy checkreqprot option to 0

The userspace API is left intact for compatibility.

Signed-off-by: Levente Polyak <levente@leventepolyak.net>
---
 Documentation/admin-guide/kernel-parameters.txt | 11 -----------
 security/selinux/hooks.c                        | 12 ------------
 security/selinux/selinuxfs.c                    | 10 +---------
 3 files changed, 1 insertion(+), 32 deletions(-)

diff --git a/Documentation/admin-guide/kernel-parameters.txt b/Documentation/admin-guide/kernel-parameters.txt
index b7decc4777b3..f7242a38a81d 100644
--- a/Documentation/admin-guide/kernel-parameters.txt
+++ b/Documentation/admin-guide/kernel-parameters.txt
@@ -776,19 +776,8 @@
 			Format: { "0" | "1" }
 			Default: 0 (1 if CONFIG_DEBUG_VM is set)

-	checkreqprot=	[SELINUX] Set initial checkreqprot flag value.
-			Format: { "0" | "1" }
-			See security/selinux/Kconfig help text.
-			0 -- check protection applied by kernel (includes
-				any implied execute protection).
-			1 -- check protection requested by application.
-			Default value is set via a kernel config option.
-			Value can be changed at runtime via
-				/sys/fs/selinux/checkreqprot.
-			Setting checkreqprot to 1 is deprecated.
-
 	cio_ignore=	[S390]
 			See Documentation/arch/s390/common_io.rst for details.

 	clearcpuid=X[,X...] [X86]
 			Disable CPUID feature X for the kernel. See
diff --git a/security/selinux/hooks.c b/security/selinux/hooks.c
index e713291db873..e05c1399b94e 100644
--- a/security/selinux/hooks.c
+++ b/security/selinux/hooks.c
@@ -137,22 +137,10 @@ static int __init selinux_enabled_setup(char *str)
 	return 1;
 }
 __setup("selinux=", selinux_enabled_setup);
 #endif
 
-static int __init checkreqprot_setup(char *str)
-{
-	unsigned long checkreqprot;
-
-	if (!kstrtoul(str, 0, &checkreqprot)) {
-		if (checkreqprot)
-			pr_err("SELinux: checkreqprot set to 1 via kernel parameter.  This is no longer supported.\n");
-	}
-	return 1;
-}
-__setup("checkreqprot=", checkreqprot_setup);
-
 /**
  * selinux_secmark_enabled - Check to see if SECMARK is currently enabled
  *
  * Description:
  * This function checks the SECMARK reference counter to see if any SECMARK
diff --git a/security/selinux/selinuxfs.c b/security/selinux/selinuxfs.c
index 232e087bce3e..c6da24809b70 100644
--- a/security/selinux/selinuxfs.c
+++ b/security/selinux/selinuxfs.c
@@ -697,24 +697,16 @@ static ssize_t sel_write_checkreqprot(struct file *file, const char __user *buf,
 
 	page = memdup_user_nul(buf, count);
 	if (IS_ERR(page))
 		return PTR_ERR(page);
 
-	if (sscanf(page, "%u", &new_value) != 1) {
+	if (sscanf(page, "%u", &new_value) != 1 || new_value) {
 		length = -EINVAL;
 		goto out;
 	}
 	length = count;
 
-	if (new_value) {
-		char comm[sizeof(current->comm)];
-
-		strscpy(comm, current->comm);
-		pr_err("SELinux: %s (%d) set checkreqprot to 1. This is no longer supported.\n",
-		       comm, current->pid);
-	}
-
 	selinux_ima_measure_state();
 
 out:
 	kfree(page);
 	return length;
-- 
2.52.0

