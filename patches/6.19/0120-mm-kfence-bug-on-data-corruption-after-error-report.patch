From 1c4c568a91fcf5a593fb9c3923b6c5c26cd5f016 Mon Sep 17 00:00:00 2001
From: Levente Polyak <levente@leventepolyak.net>
Date: Tue, 25 May 2021 21:04:47 +0200
Subject: [PATCH 120/166] mm, kfence: bug on data corruption after error report

Trigger BUG when kfence encounters data corruption of kfence managed
objects. This allows a finer-grained control instead of globally
enabling panic_on_warn.

Signed-off-by: Levente Polyak <levente@leventepolyak.net>
---
 lib/Kconfig.kfence | 9 +++++++++
 mm/kfence/report.c | 5 +++++
 2 files changed, 14 insertions(+)

diff --git a/lib/Kconfig.kfence b/lib/Kconfig.kfence
index 6fbbebec683a..e494618f7193 100644
--- a/lib/Kconfig.kfence
+++ b/lib/Kconfig.kfence
@@ -94,6 +94,15 @@ config KFENCE_KUNIT_TEST
 
 	  Say Y here if you want the test to be built into the kernel and run
 	  during boot; say M if you want the test to build as a module; say N
 	  if you are unsure.
 
+config KFENCE_BUG_ON_DATA_CORRUPTION
+	bool "Trigger a BUG when data corruption is detected"
+	default y
+	help
+	  Select this option if the kernel should BUG when kfence encounters
+	  data corruption of kfence managed objects after error report.
+
+	  If unsure, say Y.
+
 endif # KFENCE
diff --git a/mm/kfence/report.c b/mm/kfence/report.c
index 10e6802a2edf..01f8700fafc6 100644
--- a/mm/kfence/report.c
+++ b/mm/kfence/report.c
@@ -6,10 +6,11 @@
  */
 
 #include <linux/stdarg.h>
 
 #include <linux/kernel.h>
+#include <linux/bug.h>
 #include <linux/lockdep.h>
 #include <linux/math.h>
 #include <linux/printk.h>
 #include <linux/sched/debug.h>
 #include <linux/seq_file.h>
@@ -276,10 +277,14 @@ void kfence_report_error(unsigned long address, bool is_write, struct pt_regs *r
 	trace_error_report_end(ERROR_DETECTOR_KFENCE, address);
 	pr_err("==================================================================\n");
 
 	lockdep_on();
 
+#ifdef CONFIG_KFENCE_BUG_ON_DATA_CORRUPTION
+	BUG();
+#endif
+
 	check_panic_on_warn("KFENCE");
 
 	/* We encountered a memory safety error, taint the kernel! */
 	add_taint(TAINT_BAD_PAGE, LOCKDEP_STILL_OK);
 }
-- 
2.52.0

