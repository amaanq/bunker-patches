From 0c4e52e1f68c575a19cd1392e04a9828fc35c227 Mon Sep 17 00:00:00 2001
From: Daniel Micay <danielmicay@gmail.com>
Date: Wed, 3 May 2017 21:54:56 -0400
Subject: [PATCH 116/162] mm: add support for verifying page sanitization

Signed-off-by: Daniel Micay <danielmicay@gmail.com>
Signed-off-by: Thibaut Sautereau <thibaut.sautereau@ssi.gouv.fr>
Signed-off-by: Levente Polyak <levente@leventepolyak.net>
---
 include/linux/highmem.h    | 7 +++++++
 mm/page_alloc.c            | 6 ++++++
 security/Kconfig.hardening | 7 +++++++
 3 files changed, 20 insertions(+)

diff --git a/include/linux/highmem.h b/include/linux/highmem.h
index abc20f9810fd..548a9d608d58 100644
--- a/include/linux/highmem.h
+++ b/include/linux/highmem.h
@@ -257,10 +257,17 @@ static inline bool tag_clear_highpages(struct page *page, int numpages)
 	return false;
 }
 
 #endif
 
+static inline void verify_zero_highpage(struct page *page)
+{
+	void *kaddr = kmap_atomic(page);
+	BUG_ON(memchr_inv(kaddr, 0, PAGE_SIZE));
+	kunmap_atomic(kaddr);
+}
+
 /*
  * If we pass in a base or tail page, we can zero up to PAGE_SIZE.
  * If we pass in a head page, we can zero up to the size of the compound page.
  */
 #ifdef CONFIG_HIGHMEM
diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index 6e644f2744c2..2b86eadeb6c6 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -1821,10 +1821,16 @@ inline void post_alloc_hook(struct page *page, unsigned int order,
 	 * Otherwise, the poison pattern will be overwritten for __GFP_ZERO
 	 * allocations and the page unpoisoning code will complain.
 	 */
 	kernel_unpoison_pages(page, 1 << order);
 
+	if (IS_ENABLED(CONFIG_PAGE_SANITIZE_VERIFY) && want_init_on_free()) {
+		int i;
+		for (i = 0; i < (1 << order); i++)
+			verify_zero_highpage(page + i);
+	}
+
 	/*
 	 * As memory initialization might be integrated into KASAN,
 	 * KASAN unpoisoning and memory initializion code must be
 	 * kept together to avoid discrepancies in behavior.
 	 */
diff --git a/security/Kconfig.hardening b/security/Kconfig.hardening
index 07f9286f1443..b728851fec14 100644
--- a/security/Kconfig.hardening
+++ b/security/Kconfig.hardening
@@ -219,8 +219,15 @@ config SLAB_SANITIZE_VERIFY
 	  When init_on_free is enabled, verify that newly allocated slab
 	  objects are zeroed to detect write-after-free bugs.

+config PAGE_SANITIZE_VERIFY
+	bool "Verify sanitized pages"
+	default y
+	help
+	  When init_on_free is enabled, verify that newly allocated pages
+	  are zeroed to detect write-after-free bugs.
+
 endmenu

 menu "Bounds checking"

 config FORTIFY_SOURCE
-- 
2.52.0

